# TEF Services with AI-Effect Integration
#
# This docker-compose runs all TEF services with the AI-Effect control interface.
# Requires the integrated-adapters and common modules to be copied to each service directory.
#
# Prerequisites:
#   1. Copy common/ and integrated-adapters/ to this directory
#   2. Modify each service's Dockerfile to copy the adapter files
#   3. Modify each service's main.py to include the control router
#
# See RUNNING.md for detailed setup instructions.

services:
  clickhouse-server:
    image: clickhouse/clickhouse-server:latest-alpine
    container_name: tef-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=V0ltF3@t5?store
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - tef-network
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query='SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  data-provision:
    build:
      context: .
      dockerfile: data_provision/Dockerfile
    container_name: tef-data-provision
    ports:
      - "8001:600"
    depends_on:
      clickhouse-server:
        condition: service_healthy
    environment:
      - CLICKHOUSE_HOST=clickhouse-server
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=V0ltF3@t5?store
      - SELF_URL=http://data-provision:600
    volumes:
      # Mount data file - adjust path as needed
      - ./synthetic_data_generation/real_data.csv:/app/real_data.csv:ro
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:600/"]
      interval: 30s
      timeout: 10s
      retries: 3

  knowledge-store:
    build:
      context: .
      dockerfile: knowledge_store/Dockerfile
    container_name: tef-knowledge-store
    ports:
      - "8002:8000"
    environment:
      - SELF_URL=http://knowledge-store:8000
      - DATA_PROVISION_URL=http://data-provision:600
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  synthetic-data:
    build:
      context: .
      dockerfile: synthetic_data_generation/Dockerfile
    container_name: tef-synthetic-data
    ports:
      - "8003:600"
    environment:
      - ML_GRETEL_PORT=600
      - ML_GRETEL_RELOAD=False
      - SELF_URL=http://synthetic-data:600
    volumes:
      - synthetic_models:/app/models
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:600/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  clickhouse_data:
    name: tef-clickhouse-data
  synthetic_models:
    name: tef-synthetic-models

networks:
  tef-network:
    name: ai-effect-services
    driver: bridge
