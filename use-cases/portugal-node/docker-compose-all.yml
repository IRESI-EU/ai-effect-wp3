version: '3.8'

services:
  clickhouse-server:
    image: clickhouse/clickhouse-server:latest-alpine
    container_name: tef-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=V0ltF3@t5?store
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - tef-network
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query='SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  data-provision:
    build:
      context: ./data_provision
      dockerfile: Dockerfile
    container_name: tef-data-provision
    ports:
      - "8001:600"
    depends_on:
      clickhouse-server:
        condition: service_healthy
    environment:
      - CLICKHOUSE_HOST=clickhouse-server
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=V0ltF3@t5?store
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:600/"]
      interval: 30s
      timeout: 10s
      retries: 3

  knowledge-store:
    build:
      context: ./knowledge_store
      dockerfile: Dockerfile
    container_name: tef-knowledge-store
    ports:
      - "8002:8000"
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  synthetic-data:
    build:
      context: ./synthetic_data_generation
      dockerfile: Dockerfile
    container_name: tef-synthetic-data
    ports:
      - "8003:600"
    environment:
      - ML_GRETEL_PORT=600
      - ML_GRETEL_RELOAD=False
    volumes:
      - synthetic_models:/app/models
    networks:
      - tef-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:600/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  clickhouse_data:
    name: tef-clickhouse-data
  synthetic_models:
    name: tef-synthetic-models

networks:
  tef-network:
    name: tef-network
    driver: bridge
